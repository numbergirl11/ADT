import { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";

function generateProblem() {
  const num1 = Math.floor(Math.random() * 10) + 1;
  const num2 = Math.floor(Math.random() * 10) + 1;
  const operators = ["+", "-", "*"];
  const operator = operators[Math.floor(Math.random() * operators.length)];
  let answer;

  switch (operator) {
    case "+":
      answer = num1 + num2;
      break;
    case "-":
      answer = num1 - num2;
      break;
    case "*":
      answer = num1 * num2;
      break;
  }

  return { num1, num2, operator, answer };
}

export default function AcademicDiligenceTask() {
  const [task, setTask] = useState("intro");
  const [mathProblemsSolved, setMathProblemsSolved] = useState(0);
  const [mathProblemsAttempted, setMathProblemsAttempted] = useState(0);
  const [currentProblem, setCurrentProblem] = useState(generateProblem());
  const [userAnswer, setUserAnswer] = useState("");
  const [dodgePosition, setDodgePosition] = useState(50);
  const [obstaclePosition, setObstaclePosition] = useState(0);
  const [obstacleLeft, setObstacleLeft] = useState(Math.random() * 90);
  const [gameRunning, setGameRunning] = useState(false);
  const [dodgeScore, setDodgeScore] = useState(0);
  const [gameOver, setGameOver] = useState(false);
  const [speed, setSpeed] = useState(2);
  const [elapsedTime, setElapsedTime] = useState(0);
  const [lastStartTime, setLastStartTime] = useState(null);
  const [mathTime, setMathTime] = useState(0);
  const [gameTime, setGameTime] = useState(0);
  const [showCopyButton, setShowCopyButton] = useState(false);
  const [sessionEnded, setSessionEnded] = useState(false);

  useEffect(() => {
    if (task !== "none" && task !== "intro" && lastStartTime === null) {
      setLastStartTime(Date.now());
    }
  }, [task]);

  useEffect(() => {
    const timer = setInterval(() => {
      if (lastStartTime) {
        const now = Date.now();
        const delta = (now - lastStartTime) / 1000;
        setElapsedTime((prev) => prev + delta);
        if (task === "math") setMathTime((prev) => prev + delta);
        else if (task === "dodge") setGameTime((prev) => prev + delta);
        setLastStartTime(now);
      }
    }, 1000);

    return () => clearInterval(timer);
  }, [lastStartTime, task]);

  useEffect(() => {
    if (elapsedTime >= 1200 && !sessionEnded) {
      setShowCopyButton(true);
      setSessionEnded(true);
      alert("Time's up! Please copy your session data.");
    }
  }, [elapsedTime, sessionEnded]);

  const handleTaskChoice = (choice) => {
    setTask(choice);
    setGameOver(false);
    setLastStartTime(Date.now());
    if (choice === "dodge") {
      setGameRunning(true);
      setObstaclePosition(0);
      setObstacleLeft(Math.random() * 90);
      setSpeed(2);
      setDodgeScore(0);
    } else if (choice === "math") {
      setCurrentProblem(generateProblem());
      setUserAnswer("");
    }
  };

  const solveMathProblem = () => {
    setMathProblemsAttempted((prev) => prev + 1);
    if (parseInt(userAnswer) === currentProblem.answer) {
      setMathProblemsSolved((prev) => prev + 1);
    }
    setCurrentProblem(generateProblem());
    setUserAnswer("");
  };

  const handleKeyDown = (event) => {
    if (event.key === "Enter") {
      solveMathProblem();
    } else if (event.key === "ArrowLeft") {
      setDodgePosition((prev) => Math.max(0, prev - 10));
    } else if (event.key === "ArrowRight") {
      setDodgePosition((prev) => Math.min(90, prev + 10));
    }
  };

  useEffect(() => {
    window.addEventListener("keydown", handleKeyDown);
    return () => {
      window.removeEventListener("keydown", handleKeyDown);
    };
  }, [userAnswer]);

  useEffect(() => {
    if (gameRunning) {
      const interval = setInterval(() => {
        setObstaclePosition((prev) => {
          if (prev >= 100) {
            setObstacleLeft(Math.random() * 90);
            setDodgeScore((score) => score + 1);
            setSpeed((prevSpeed) => Math.min(prevSpeed + 0.2, 4));
            return 0;
          }
          if (prev >= 90 && Math.abs(dodgePosition - obstacleLeft) < 10) {
            setGameRunning(false);
            setGameOver(true);
          }
          return prev + speed;
        });
      }, 100);
      return () => clearInterval(interval);
    }
  }, [gameRunning, speed, dodgePosition, obstacleLeft]);

  const handleCopyData = () => {
    const percentCorrect = mathProblemsAttempted > 0 ? Math.round((mathProblemsSolved / mathProblemsAttempted) * 100) : 0;
    const text = `Time spent on math: ${Math.floor(mathTime)}s, Time spent on games: ${Math.floor(gameTime)}s, Math problems attempted: ${mathProblemsAttempted}, Math accuracy: ${percentCorrect}%`;
    navigator.clipboard.writeText(text).then(() => {
      alert("Session data copied! You can now paste it into the Google Form.");
    });
  };

  const handleReset = () => {
    setTask("intro");
    setMathProblemsSolved(0);
    setMathProblemsAttempted(0);
    setUserAnswer("");
    setDodgeScore(0);
    setGameOver(false);
    setSpeed(2);
    setElapsedTime(0);
    setLastStartTime(null);
    setMathTime(0);
    setGameTime(0);
    setShowCopyButton(false);
    setSessionEnded(false);
  };

  return (
    <div className="flex items-start justify-center min-h-screen p-4">
      {task === "intro" ? (
        <Card className="p-6 max-w-3xl mx-auto">
          <h1 className="text-2xl font-bold mb-4">Welcome to Focus Duel</h1>
          <p className="mb-2">We are going to do some math problems for a few minutes. Try to solve as many problems as quickly and accurately as you can. Enter your answer and either hit "enter" on the keyboard or click "submit."</p>
          <p className="mb-2">You are doing this activity because it can make you smarter. Research shows that practicing basic math skills, like simple math, makes you a better problem solver. The more problems that you do, the better you will be at solving problems in the future.</p>
          <p className="mb-2">If you feel like it, you are free to click on "Play Reaction Dodge" to play a fun game. But remember, the more problems you complete, the more likely it is that your problem-solving ability will improve.</p>
          <p className="mb-4">You will not be graded on any of this activity and you are free to choose whichever you want. If you have any questions for your teacher before you begin, please raise your hand.</p>
          <div className="text-center">
            <Button onClick={() => setTask("none")}>Start</Button>
          </div>
        </Card>
      ) : (
        <div className="flex flex-col md:flex-row w-full">
          <div className="md:w-1/2 p-4">
            <Card className="p-4 text-center">
              <h1 className="text-xl font-bold mb-4">Focus Duel</h1>
              <Button onClick={() => handleTaskChoice("math")} className="mr-2">Solve Math Problems</Button>
              <Button onClick={() => handleTaskChoice("dodge")}>Play Reaction Dodge</Button>
              {showCopyButton && (
                <div className="mt-4">
                  <Button onClick={handleCopyData} className="mr-2">Copy Session Data</Button>
                  <Button onClick={handleReset} variant="outline">Reset</Button>
                </div>
              )}
            </Card>
          </div>
          <div className="md:w-1/2 p-4">
            {task === "math" && (
              <Card className="p-6 text-center">
                <h2 className="text-xl font-bold">Solve the Math Problem</h2>
                <p>{currentProblem.num1} {currentProblem.operator} {currentProblem.num2} = ?</p>
                <input 
                  type="number" 
                  value={userAnswer} 
                  onChange={(e) => setUserAnswer(e.target.value)}
                  className="border p-2"
                />
                <Button onClick={solveMathProblem} className="ml-2">Submit</Button>
              </Card>
            )}
            {task === "dodge" && (
              <div className="text-center">
                <h2 className="text-xl font-bold">Reaction Dodge</h2>
                <p>Score: {dodgeScore}</p>
                {gameOver ? (
                  <div>
                    <h3 className="text-red-500">Game Over!</h3>
                    <Button onClick={() => handleTaskChoice("dodge")}>Play Again</Button>
                  </div>
                ) : (
                  <div className="relative w-64 h-64 bg-gray-200 mx-auto">
                    <div className="absolute bg-blue-500 w-10 h-10" style={{ left: `${dodgePosition}%`, bottom: "10px" }}></div>
                    <div className="absolute bg-red-500 w-10 h-10" style={{ left: `${obstacleLeft}%`, top: `${obstaclePosition}%` }}></div>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}
